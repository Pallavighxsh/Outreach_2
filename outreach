import nltk
from nltk import word_tokenize, pos_tag
from nltk.corpus import stopwords

nltk.download("punkt")
nltk.download("averaged_perceptron_tagger")
nltk.download("stopwords")

STOPWORDS = set(stopwords.words("english"))

def extract_proper_nouns(body_text):
    """Return all NNP/NNPS tokens."""
    tokens = word_tokenize(body_text)
    tagged = pos_tag(tokens)

    proper_nouns = [word for word, tag in tagged if tag in ("NNP", "NNPS")]
    return proper_nouns


def extract_names_nltk(body_text):
    """Extract 2-word Proper Noun sequences (names)."""
    tokens = word_tokenize(body_text)
    tagged = pos_tag(tokens)

    names = []
    for i in range(len(tagged) - 1):
        if tagged[i][1] == "NNP" and tagged[i+1][1] == "NNP":
            names.append(f"{tagged[i][0]} {tagged[i+1][0]}")

    return list(set(names))


def extract_buzzwords_from_nouns(proper_nouns, names):
    """
    Buzzwords = All Proper Nouns - Names - Stopwords - Junk
    """
    name_parts = set()
    for n in names:
        for part in n.split():
            name_parts.add(part)

    buzz = []
    for word in proper_nouns:
        # remove name components
        if word in name_parts:
            continue

        # skip trivial words
        if word.lower() in STOPWORDS:
            continue

        if len(word) <= 2:
            continue

        # keep only alphabetic or mixed-case words (skip numbers)
        if not any(c.isalpha() for c in word):
            continue

        buzz.append(word)

    return list(set(buzz))


def extract_contact_info(body_text):
    """Emails + NLTK names + NLTK-derived buzzwords"""
    data = {}

    # Emails
    emails = re.findall(
        r"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}",
        body_text
    )
    data["emails"] = list(set(emails))

    # Names (full 2-word proper noun sequences)
    names = extract_names_nltk(body_text)
    data["names"] = names

    # Buzzwords (auto-discovered)
    proper_nouns = extract_proper_nouns(body_text)
    buzzwords = extract_buzzwords_from_nouns(proper_nouns, names)
    data["buzzwords"] = buzzwords

    return data
